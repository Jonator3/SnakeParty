<html>
<head>
<meta name='viewport' content='width=device-width, initial-scale=0.8, user-scalable=no'>
<title>Controller</title>
<style>* { margin: 0; padding: 0; }html, body { width: 100%; height: 100%; }canvas { display: block; }</style>
</head>
<body id='body'>
<canvas id='canvas'></canvas>
<script>

var id = new URLSearchParams(window.location.search).get('key');
var colors = ["#555555","#5064FF","#FF8200","#AAFF14","#FF1414","#FAF000","#14FF8C","#FA6496","#FAFAFA","#DC00FA","#00FFC8"];
var color = colors[0];
var bk_color = "#333333"
const socket = new WebSocket('ws://' + location.hostname + ':41800');

socket.addEventListener('open', function (event) {
    socket.send("id:" + id);});

socket.addEventListener('message', function (event) {
    if(event.data.startsWith("C:")){
        color = colors[parseInt(event.data.split(":")[1])];
    }if(event.data.startsWith("G:")){
        var data = event.data.split(":")[1].split(";");
        drawGame(data);
    }if(event.data.startsWith("W:")){
        var data = event.data.split(":")[1];
        drawWaitGame(data);
    }if(event.data.startsWith("M:")){
        var data = event.data.split(":")[1].split(";");
        drawMenu(data);
    }if(event.data.startsWith("E:")){
        var data = event.data.split(":")[1];
        drawEndGame(data);
    }
    console.log('server says: ', event.data);});

var bodyElem = document.getElementById('body');
bodyElem.addEventListener('keypress', function(event) {
    var key = event.keyCode;
    console.log('key:'+ key);
    if(key==97) {
        socket.send('l');
        console.log('left');}
    if(key==119){
        socket.send('u');
        console.log('up');}
    if(key==100){
        socket.send('r');
        console.log('right');}
    if(key==13){
        socket.send('e');
        console.log('enter');}
    if(key==115 ){
        socket.send('d');
        console.log('down');}}, false);
bodyElem.addEventListener('touchstart', function(event) {
    var touch = event.touches[0]
    if((touch.clientX / bodyElem.clientWidth) / (touch.clientY / bodyElem.clientHeight) < 1) {
        if((touch.clientX / bodyElem.clientWidth) / ((bodyElem.clientHeight - touch.clientY) / bodyElem.clientHeight) < 1) {
            socket.send('l');console.log('left');}
        else {socket.send('d');
            console.log('down');}}
    else {
        if(((bodyElem.clientWidth - touch.clientX) / bodyElem.clientWidth) / (touch.clientY / bodyElem.clientHeight) < 1) {
            socket.send('r');
            console.log('right');}
        else {
            socket.send('u');
            console.log('up');}}}, false);

function draw() {
    var canvasElem = document.getElementById('canvas');
    canvasElem.width = window.innerWidth;
    canvasElem.height = window.innerHeight;
    var isHorizontal = canvasElem.width > canvasElem.height;
    var smallside = 0;
    if(isHorizontal){
        smallside = canvasElem.height;
    }else {
        smallside = canvasElem.width;
    }
    var ctx = canvasElem.getContext('2d');
    ctx.fillStyle = bk_color;
    ctx.fillRect(0, 0, canvasElem.width, canvasElem.height);
    ctx.fillStyle = color;
    ctx.fillRect(0, 0, smallside, smallside);
    ctx.fillStyle = bk_color;
    ctx.fillRect(20, 20, smallside-40, smallside-40);}
function drawEndGame(data) {
    // TODO
}
function drawWaitGame(data) {
    // TODO
}
function drawMenu(data) {
    // TODO
}
function drawGame(data) {
    var canvasElem = document.getElementById('canvas');
    var size = 15;
    var fieldsize = 0;
    var isHorizontal = canvasElem.width > canvasElem.height;
    var smallside = 0;
    if(isHorizontal){
        fieldsize = (canvasElem.height-40)/size;
        smallside = canvasElem.height;
    }else {
        fieldsize = (canvasElem.width-40)/size;
        smallside = canvasElem.width;
    }
    ctx.fillStyle = bk_color;
    ctx.fillRect(0, 0, smallside, smallside);
    ctx.fillStyle = color;
    ctx.fillRect(0, 0, smallside, smallside);
    for (let i=0;i<data[0].length;i++){
        var c = data[0].charAt(i);
        if(i == 0){
            size = parseInt(c,32)
            continue;
        }
        var n = parseInt(c, 16);
        var posX = (i-1)%size;
        var posY = Math.floor((i-1)/size);
        if(n<11){
            ctx.fillStyle = colors[n];
            ctx.fillRect(posX+20, posY+20, fieldsize, fieldsize);
        }
    }
    for(let i=1;i<data.length;i++){
        var d = data[i].split(",");
        var c = parseInt(d[0], 16);
        var score = parseInt(d[1], 16);
        // TODO -- draw board
    }
}
draw();
window.addEventListener('resize', function(event){draw();});

</script>
</body>
</html>
